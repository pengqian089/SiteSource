function musicInit(){function h(n){f.innerHTML="";const r=t.get(n);let i=document.createElement("ul");for(let n of r){let t=document.createElement("li");t.innerHTML=n[1];i.appendChild(t)}f.appendChild(i);c()}function c(){const t=document.querySelectorAll(".meta-lyrics ul li");for(let n of t)n.classList.remove("active");t[n].classList.add("active");n>s&&(document.querySelectorAll(".meta-lyrics ul")[0].style.transform=`translateY(-${(n-s+2)*l}px)`)}function a(i,r){const u=t.get(r);for(let t=n;t<u.length;t++)if(i<u[t+1][0]&&i>u[t][0]){n=t;break}}function v(n){if(n){n=n.replace(/([^\]^\n])\[/g,(n,t)=>t+"\n[");const i=n.split("\n");let t=[];const r=i.length;for(let n=0;n<r;n++){const r=i[n].match(/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g),u=i[n].replace(/.*\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g,"").replace(/<(\d{2}):(\d{2})(\.(\d{2,3}))?>/g,"").replace(/^\s+|\s+$/g,"");if(r){const n=r.length;for(let i=0;i<n;i++){const n=/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/.exec(r[i]),f=n[1]*60,e=parseInt(n[2]),o=n[4]?parseInt(n[4])/((n[4]+"").length===2?100:1e3):0,s=f+e+o;t.push([s,u])}}}return t=t.filter(n=>n[1]),t.sort((n,t)=>n[0]-t[0]),t[t.length]=[t[t.length-1][0]+3,""],t}return[]}let i=document.getElementsByClassName("song"),e=[],o=document.title,u=document.getElementsByClassName("amplitude-volume-slider")[0],r=50,n=0,s=2,l=20,f=document.getElementsByClassName("meta-lyrics")[0],t=new Map;localStorage["music-volume"]===undefined?localStorage["music-volume"]=u.value:(r=parseInt(localStorage["music-volume"]),u.value=isNaN(r)?50:r);u.addEventListener("change",function(){localStorage["music-volume"]=this.value});for(let r=0;r<i.length;r++)i[r].addEventListener("click",function(){this.querySelectorAll(".play-button-container")[0].style.display="none"}),e.push({name:i[r].dataset.title,artist:i[r].dataset.artist,album:"曲库音乐",url:i[r].dataset.url,cover_art_url:i[r].dataset.cover,visualization:"michaelbromley_visualization",lrc:i[r].dataset.lrc,time_callbacks:{0:function(){let i=Amplitude.getActiveSongMetadata();if(n=0,t.has(i.url))h(i.url);else{const n=new XMLHttpRequest;n.onreadystatechange=()=>{n.readyState===4&&(n.status>=200&&n.status<300||n.status===304?(t.set(i.url,v(n.responseText)),h(i.url)):console.log(`LRC file request fails: status ${n.status}`))};n.open("get",i.lrc,!0);n.send(null)}}}});Amplitude.init({songs:e,volume:r,callbacks:{play:function(){document.getElementById("album-art").style.visibility="hidden";document.getElementById("large-visualization").style.visibility="visible";let n=Amplitude.getActiveSongMetadata();document.title=`正在播放《${n.name}》 - ${n.artist} ${o}`},pause:function(){document.getElementById("album-art").style.visibility="visible";document.getElementById("large-visualization").style.visibility="hidden";document.title=o},timeupdate:function(){const i=Amplitude.getActiveSongMetadata();if(t.get(i.url)!==undefined){const r=t.get(i.url),u=event.path[0].currentTime;if(n===r.length)return;a(u,i.url);c()}else f.innerHTML="loading..."},seeked:function(){const i=Amplitude.getActiveSongMetadata();if(t.get(i.url)!==undefined){const u=event.path[0].currentTime,r=t.get(i.url);for(let t=0;t<r.length;t++)if(u<r[t+1][0]&&u<r[t][0]){n=t;break}}}},waveforms:{sample_rate:100},visualization:"michaelbromley_visualization",visualizations:[{object:MichaelBromleyVisualization,params:{}}]});document.getElementById("large-visualization").style.height=document.getElementById("album-art").offsetWidth+"px"}$(function(){typeof Amplitude=="undefined"?$.when($.getScript("/lib/amplitudejs/amplitude.min.js"),$.getScript("/lib/amplitudejs/visualizations/michaelbromley.js"),$.Deferred(function(n){$(n.resolve)})).done(function(){musicInit()}):musicInit()});